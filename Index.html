<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昭和風英文口說測驗系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 UMD 版本的 React 以確保與 Babel 兼容 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;900&display=swap');
        body {
            background-color: #F4EAD5;
            color: #3E2723;
            font-family: 'Noto Serif TC', serif;
        }
        .vintage-border {
            border: 2px solid #5D4037;
            box-shadow: 4px 4px 0px #3E2723;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 1. 先載入 Firebase (使用原生 Module) 並將其掛載到 window 全域變數 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            // 注意：請在此填入您的 API Key，或確保部署環境已注入
            apiKey: "", 
            authDomain: "oralexamsystem.firebaseapp.com",
            projectId: "oralexamsystem",
            storageBucket: "oralexamsystem.firebasestorage.app",
            messagingSenderId: "86477996314",
            appId: "1:86477996314:web:b8d7772853805d6d6feca3"
        };

        try {
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                window.FB = {
                    db: getFirestore(app),
                    auth: getAuth(app),
                    firestore: { doc, setDoc, onSnapshot, updateDoc, deleteDoc, collection },
                    authActions: { signInAnonymously, onAuthStateChanged }
                };
            } else {
                console.warn("Firebase API Key is missing. Please provide it in the source code.");
                window.FB = null;
            }
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            window.FB = null;
        }
        
        // 發送通知事件
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- 2. React 邏輯 (使用 Babel) -->
    <script type="text/babel" data-presets="react">
        const { useState, useEffect } = React;

        function App() {
            const [fbStatus, setFbStatus] = useState(window.FB ? 'ready' : 'checking');
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [session, setSession] = useState(null);
            const [history, setHistory] = useState([]);

            const appId = "showa-exam-final";
            const studentList = ["張小明", "李大華", "王曉玲", "趙敏", "考官測試用"];
            const EXAM_DATA = {
                words: ["Adventure", "Beautiful", "Calendar", "Delicious", "Education"],
                sentences: ["Practice makes perfect.", "Knowledge is power."],
                grammar: ["If I were you, I would go."]
            };

            useEffect(() => {
                const handleReady = () => {
                    setFbStatus(window.FB ? 'ready' : 'missing-key');
                };
                window.addEventListener('firebase-ready', handleReady);
                // 立即檢查一次
                if (window.FB) setFbStatus('ready');
                return () => window.removeEventListener('firebase-ready', handleReady);
            }, []);

            useEffect(() => {
                if (fbStatus !== 'ready' || !window.FB) return;
                const { auth, authActions } = window.FB;
                authActions.signInAnonymously(auth).catch(err => {
                    console.error("Auth Error:", err);
                    setFbStatus('auth-error');
                });
                return authActions.onAuthStateChanged(auth, setUser);
            }, [fbStatus]);

            useEffect(() => {
                if (!user || fbStatus !== 'ready') return;
                const { db, firestore } = window.FB;
                
                const sessionRef = firestore.doc(db, 'artifacts', appId, 'public', 'data', 'current_session');
                const unsubSession = firestore.onSnapshot(sessionRef, (doc) => {
                    setSession(doc.exists() ? doc.data() : null);
                }, (err) => console.error("Session Sync Error:", err));

                const historyRef = firestore.collection(db, 'artifacts', appId, 'public', 'data', 'history');
                const unsubHistory = firestore.onSnapshot(historyRef, (snap) => {
                    const docs = snap.docs.map(d => d.data());
                    setHistory(docs.sort((a, b) => b.timestamp - a.timestamp));
                }, (err) => console.error("History Sync Error:", err));

                return () => { unsubSession(); unsubHistory(); };
            }, [user, fbStatus]);

            const submitScore = async (type, score) => {
                if (!window.FB) return;
                const { db, firestore } = window.FB;
                const sessionRef = firestore.doc(db, 'artifacts', appId, 'public', 'data', 'current_session');
                let updates = { [`scores.${type}`]: score };
                
                if (type === 'word') {
                    const nextCount = (session.wordCount || 0) + 1;
                    updates.wordCount = nextCount;
                    if (nextCount >= 5) {
                        updates.step = 'sentence';
                        updates.currentItem = "請點擊抽取短句";
                    } else {
                        updates.currentItem = EXAM_DATA.words[nextCount % EXAM_DATA.words.length];
                    }
                } else if (type === 'sentence') {
                    updates.step = 'grammar';
                    updates.currentItem = "請點擊抽取問答";
                } else if (type === 'grammar') {
                    updates.step = 'result';
                }
                await firestore.updateDoc(sessionRef, updates);
            };

            // 錯誤處理介面
            if (fbStatus === 'missing-key') {
                return (
                    <div className="flex h-screen items-center justify-center p-6 text-center">
                        <div className="bg-white p-8 vintage-border max-w-sm">
                            <h2 className="text-xl font-bold text-red-800 mb-4">系統配置錯誤</h2>
                            <p className="text-sm opacity-70 mb-4">Firebase API Key 尚未設定。請在程式碼中的 firebaseConfig 填入有效的 apiKey。</p>
                            <button onClick={() => window.location.reload()} className="bg-[#5D4037] text-white px-4 py-2 text-xs">重試</button>
                        </div>
                    </div>
                );
            }

            if (fbStatus === 'checking' || !user) {
                return <div className="flex h-screen items-center justify-center italic">通信中...</div>;
            }

            if (!role) {
                return (
                    <div className="flex flex-col h-screen items-center justify-center space-y-8 bg-[#F4EAD5]">
                        <h1 className="text-5xl font-black text-[#2D5A27] border-y-4 border-double border-[#5D4037] py-4 px-8 tracking-widest">昭和英語考查</h1>
                        <div className="flex flex-col gap-4 w-64">
                            <button onClick={() => setRole('student')} className="bg-[#A52A2A] text-white py-4 font-bold vintage-border">受驗生入口</button>
                            <button onClick={() => setRole('teacher')} className="bg-[#2D5A27] text-white py-4 font-bold vintage-border">教員控制端</button>
                        </div>
                    </div>
                );
            }

            if (role === 'teacher') {
                return (
                    <div className="max-w-xl mx-auto p-4">
                        <div className="flex justify-between items-center mb-6 border-b-2 border-[#5D4037]">
                            <h2 className="text-2xl font-black">教員端</h2>
                            <button onClick={() => setRole(null)} className="text-xs border px-2 py-1">返回</button>
                        </div>
                        {!session ? (
                            <div className="bg-white p-10 text-center vintage-border italic opacity-50 text-stone-500">等待學生登錄中...</div>
                        ) : (
                            <div className="space-y-4">
                                <div className="bg-[#FFF9EB] p-4 vintage-border flex justify-between font-bold">
                                    <span>受驗生：{session.studentName}</span>
                                    <span className="text-[#A52A2A] uppercase">{session.step}</span>
                                </div>
                                {session.step === 'words' && (
                                    <div className="grid grid-cols-2 gap-4">
                                        <button onClick={() => submitScore('word', (session.scores.word || 0) + 1)} className="bg-green-700 text-white py-8 text-2xl font-black vintage-border">✓ 正確</button>
                                        <button onClick={() => submitScore('word', session.scores.word || 0)} className="bg-red-900 text-white py-8 text-2xl font-black vintage-border">✗ 錯誤</button>
                                    </div>
                                )}
                                {(session.step === 'sentence' || session.step === 'grammar') && (
                                    <div className="bg-white p-6 vintage-border text-center">
                                        <p className="mb-4 font-bold">評分 (0-5 分)</p>
                                        <div className="flex justify-center gap-2">
                                            {[0, 1, 2, 3, 4, 5].map(s => (
                                                <button key={s} onClick={() => submitScore(session.step, s)} className="w-12 h-12 bg-[#2D5A27] text-white font-black vintage-border text-xl">{s}</button>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {session.step === 'result' && (
                                    <button onClick={async () => {
                                        const { db, firestore } = window.FB;
                                        const historyRef = firestore.doc(firestore.collection(db, 'artifacts', appId, 'public', 'data', 'history'));
                                        await firestore.setDoc(historyRef, { ...session, timestamp: Date.now() });
                                        await firestore.deleteDoc(firestore.doc(db, 'artifacts', appId, 'public', 'data', 'current_session'));
                                    }} className="w-full bg-black text-white py-4 font-bold vintage-border">存檔並結束考查</button>
                                )}
                            </div>
                        )}
                        <div className="mt-8">
                            <p className="font-bold border-l-4 border-green-800 pl-2 mb-2">歷史成績單</p>
                            <div className="bg-white vintage-border text-xs divide-y">
                                {history.map((h, i) => (
                                    <div key={i} className="p-2 flex justify-between">
                                        <span>{h.studentName}</span>
                                        <span className="font-bold text-red-800">總分：{(h.scores.word||0)+(h.scores.sentence||0)+(h.scores.grammar||0)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto p-4 h-screen flex flex-col justify-center">
                    {!session ? (
                        <div className="bg-[#FFF9EB] p-8 vintage-border space-y-6">
                            <h2 className="text-2xl font-black text-center">受驗生登錄</h2>
                            <select id="sName" className="w-full p-3 bg-white border-2 border-[#5D4037] font-bold">
                                <option value="">請選取您的姓名</option>
                                {studentList.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                            <button onClick={async () => {
                                const { db, firestore } = window.FB;
                                const name = document.getElementById('sName').value;
                                if (!name) return;
                                await firestore.setDoc(firestore.doc(db, 'artifacts', appId, 'public', 'data', 'current_session'), {
                                    studentName: name,
                                    step: 'words',
                                    scores: { word: 0, sentence: 0, grammar: 0 },
                                    wordCount: 0,
                                    currentItem: EXAM_DATA.words[0],
                                    timestamp: Date.now()
                                });
                            }} className="w-full bg-[#A52A2A] text-white py-4 font-black vintage-border">開始考查</button>
                        </div>
                    ) : (
                        <div className="bg-white p-8 vintage-border text-center space-y-8 relative min-h-[300px] flex flex-col justify-center">
                            {session.step === 'result' ? (
                                <div className="space-y-6">
                                    <h3 className="text-3xl font-black text-[#A52A2A]">考查終了</h3>
                                    <div className="text-5xl font-black border-4 border-double border-[#5D4037] py-6 mx-4 bg-stone-50">
                                        {(session.scores.word||0) + (session.scores.sentence||0) + (session.scores.grammar||0)}
                                        <span className="text-sm ml-2">點</span>
                                    </div>
                                    <p className="text-xs italic opacity-60">請靜候教員指示離場</p>
                                </div>
                            ) : (
                                <div>
                                    <div className="text-xs font-bold opacity-30 absolute top-4 left-4">EXAM IN PROGRESS</div>
                                    <h2 className="text-4xl font-black leading-tight">{session.currentItem}</h2>
                                    {session.currentItem.includes("請點擊抽取") && (
                                        <button onClick={() => {
                                            const { db, firestore } = window.FB;
                                            const pool = session.step === 'sentence' ? EXAM_DATA.sentences : EXAM_DATA.grammar;
                                            const random = pool[Math.floor(Math.random() * pool.length)];
                                            firestore.updateDoc(firestore.doc(db, 'artifacts', appId, 'public', 'data', 'current_session'), { currentItem: random });
                                        }} className="mt-8 bg-yellow-600 text-white px-6 py-2 font-bold vintage-border animate-bounce">抽取題目</button>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
